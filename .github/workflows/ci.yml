name: ci

on:
  push:
    branches:
      - master
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
  pull_request:

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@24cb9080177205b6e8c946b17badbe402adc938f # v3.4.0
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@6edd4406fa81c3da01a34fa6f6343087c207a568 # v3.5.0
        with:
          go-version: "1.19"
          cache: true

      - name: ci/check-style
        run: make check-style

      - name: ci/check-modules
        run: make check-modules

      - name: ci/check-mocks
        run: make verify-mocks

  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: cimg/postgres:12.11
        env:
          POSTGRES_USER: cloud_test
          POSTGRES_DB: cloud_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repo
        uses: actions/checkout@24cb9080177205b6e8c946b17badbe402adc938f # v3.4.0
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@6edd4406fa81c3da01a34fa6f6343087c207a568 # v3.5.0
        with:
          go-version: "1.19"
          cache: true

      - name: ci/test-sqlite
        run: make unittest goverall

      - name: ci/test-testwick
        run: make unittest
        working-directory: ./cmd/tools/testwick

      - name: ci/test-postgres
        run: make unittest
        env:
          CLOUD_DATABASE: postgres://cloud_test@localhost:5432/cloud_test?sslmode=disable

  pull_request:
    if: ${{ github.event_name == 'pull_request' }}
    needs: [lint, test]
    uses: ./.github/workflows/cd.yml
    with:
      tag: ${GITHUB_SHA:0:7}

  master:
    if: ${{ github.ref_name  == 'master' }}
    needs: [lint, test]
    uses: ./.github/workflows/cd.yml
    with:
      tag: ${GITHUB_SHA:0:7}

  tag:
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
    needs: [lint, test]
    uses: ./.github/workflows/cd.yml
    with:
      tag: ${GITHUB_REF_NAME}
